# scripts/object_detection.py
from ultralytics import YOLO
import numpy as np

def load_model(model_path="yolov8s.pt"):
    """
    Load and return a YOLO model (Ultralytics API).
    """
    model = YOLO(model_path)
    return model

def detect_and_annotate(model, frame, conf=0.4):
    """
    Run YOLO on a single frame and return:
      - annotated_frame: image with boxes drawn (numpy array)
      - detections: list of dicts {name, conf, xyxy}
    """
    results = model(frame, conf=conf)  # returns a Results object or list-like
    res = results[0]  # first (and only) frame result
    annotated = res.plot()  # image (numpy) with boxes drawn by ultralytics

    detections = []
    # res.boxes is iterable; each box has xyxy, conf, cls
    for box in res.boxes:
        try:
            xyxy = box.xyxy[0].cpu().numpy()  # [x1, y1, x2, y2]
            conf_score = float(box.conf[0])
            cls_id = int(box.cls[0])
        except Exception:
            # fallback if tensors are plain python-friendly
            xyxy = box.xyxy[0].numpy()
            conf_score = float(box.conf[0])
            cls_id = int(box.cls[0])

        name = model.names.get(cls_id, str(cls_id))
        detections.append({
            "name": name,
            "conf": conf_score,
            "xyxy": [int(x) for x in xyxy]
        })

    return annotated, detections
